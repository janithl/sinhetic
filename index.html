<!DOCTYPE html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Sinhetic</title>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="ratchet/css/ratchet.min.css">
    <link rel="stylesheet" href="ratchet/css/ratchet-theme-ios.min.css">
    <style>	
    #translation {
		min-height: 71px;
		padding: 5px;
		margin: 0 0 20px;
	}
	
	#dictionary {
		height: 52px;
		margin: 0 5px;
		padding: 5px 0;
		border-top: 1px solid #ddd;
		overflow: hidden;
	}
	
	.word {
		display: inline-block;
		margin: 5px;
		padding: 5px;
		background: #ddd;
		color: #111;
	}
	
	.activeword {
		background: #aaa;
	}
	
	#bottom-bar {
		height: auto;
	}
    </style>
    
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="ratchet/js/ratchet.min.js"></script>
    <script type="text/javascript" src="js/lodash.min.js"></script>
    <script type="text/javascript" src="js/sinhala.js"></script>
    <script type="text/javascript" src="js/sinhaladict.js"></script>
    <script type="text/javascript">
	var tr = {
		content		: null,
		pinput		: null,
		dict		: null,
		wordlist	: [],
		
		create: function() {
			tr.content	= document.getElementById("content");
			tr.pinput	= document.getElementById("pinput");
			tr.dict		= document.getElementById("dictionary");
		},
		
		engToSin: function(e) {
			if((e.keyCode == 13 || e.keyCode == 32 || _.last(tr.pinput.value) == ' ') && tr.pinput.value.replace(/\s/g, '') != '') {
				var words = tr.pinput.value.split(' ');
				tr.wordlist.push({ lat: words[0], si: Sinhala.fromLatin(words[0]) });
				tr.pinput.value = (words.length > 1) ? words[1] : '';

				tr.content.scrollTop = tr.content.scrollHeight;
				tr.renderWordList();
			}
			
			if(tr.pinput.value.replace(/\s/g, '') != '') {
				var s = Sinhala.fromLatin(tr.pinput.value);
				tr.dict.innerHTML	= '<div class="word activeword">' + s + '</div>';
				var regexp			= new RegExp(s, 'i'); 
				
				/* Async this */
				setTimeout(function() {
					var matches = _.filter(SinhalaDict, function(elem) {
						return regexp.test(elem);
					});
					
					if(matches.length > 0) {
						tr.dict.innerHTML += '<div class="word" onclick="tr.addWord(this)">' + matches.join('</div><div class="word" onclick="tr.addWord(this)">') + '</div>';
					}
				}, 0);
			}
			else {
				tr.dict.innerHTML = '';
			}
		},
		
		renderWordList: function() {
			document.getElementById('translation').innerHTML = '<div class="word">' + _.pluck(tr.wordlist, 'si').join('</div><div class="word">') + '</div>';
		},
		
		addWord: function(element) {
			tr.wordlist.push({ lat: Sinhala.toLatin(element.innerHTML), si: element.innerHTML });
			tr.renderWordList();
			
			tr.dict.innerHTML	= '';
			tr.pinput.value		= '';
			tr.pinput.focus();
		},
		
		copyText: function() {
			//window.plugins.copy(tr.wordlist.join(' '));
			alert('Text Copied to Clipboard: ' + _.pluck(tr.wordlist, 'si').join(' ')); // change to toast
		}
	}
	
	document.addEventListener("deviceready", tr.create, false);
    </script>
  </head>
  <body onload="tr.create()">
    <header class="bar bar-nav">
      <a class="icon icon-share pull-right" onclick="tr.copyText()"></a>
      <h1 class="title">Sinhetic</h1>
    </header>
    
    <div id="bottom-bar" class="bar bar-footer">
		<div id="dictionary"></div>
		<input id="pinput" type="text" placeholder="Type Here" onkeyup="tr.engToSin(event)" autofocus>
	</div>
	
    <div class="content" id="content">
		<div id="translation"></div>
	</div>
  </body>
</html>
