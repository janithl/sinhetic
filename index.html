<!DOCTYPE html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Sinhetic</title>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="ratchet/css/ratchet.min.css">
    <link rel="stylesheet" href="ratchet/css/ratchet-theme-ios.min.css">
    <style>	
    #content {
		padding: 10px;
	}
	
    #translation {
		min-height: 61px;
		margin: 0 0 20px;
	}
	
	#dictionary {
		height: 42px;
		padding: 5px 0;
		border-top: 1px solid #ddd;
		overflow: hidden;
	}
	
	.word {
		display: inline-block;
		margin: 0 5px 5px 0;
		padding: 5px;
		background: #ddd;
		color: #111;
	}
	
	.activeword {
		background: #aaa;
	}
	
	#bottom-bar {
		height: auto;
	}
    </style>
    
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="ratchet/js/ratchet.min.js"></script>
    <script type="text/javascript" src="js/lodash.min.js"></script>
    <script type="text/javascript" src="js/sinhala.js"></script>
    <script type="text/javascript" src="js/sinhaladict.js"></script>
    <script type="text/javascript">
	var tr = {
		content		: null,
		pinput		: null,
		dict		: null,
		wordlist	: [],
		
		create: function() {
			tr.trans	= document.getElementById("translation");
			tr.pinput	= document.getElementById("pinput");
			tr.dict		= document.getElementById("dictionary");
		},
		
		engToSin: function(e) {
			/** 
				if an enter key or the space bar has been pressed, add word
				to wordlist. If multiple words have been entered, enter just the 
				first word into wordlist 
			*/
			if((e.keyCode == 13 || e.keyCode == 32 || _.last(tr.pinput.value) == ' ') && tr.pinput.value.replace(/\s/g, '') != '') {
				var words = tr.pinput.value.split(' ');
				tr.addWord(Sinhala.fromLatin(words[0]), words[0]);
				tr.pinput.value = (words.length > 1) ? words.slice(1).join(' ') : '';
			}
			
			/** translate latin input into sinhala unicode output */
			if(tr.pinput.value.replace(/\s/g, '') != '') {
				var s = Sinhala.fromLatin(tr.pinput.value);
				tr.dict.innerHTML	= '<div class="word activeword">' + s + '</div>';
				var regexp			= new RegExp(s, 'i'); 
				
				/** async dictionary lookup */
				setTimeout(function() {
					var matches = _.filter(SinhalaDict, function(elem) {
						return regexp.test(elem);
					});
					
					/** display matches. slice just 9 elements out of the array for speed */
					if(matches.length > 0) {
						tr.dict.innerHTML += '<div class="word" onclick="tr.addWord(this.innerHTML)">' + matches.slice(0,9).join('</div><div class="word" onclick="tr.addWord(this.innerHTML)">') + '</div>';
					}
				}, 0);
			}
			else {
				tr.dict.innerHTML = '';
			}
		},
		
		addWord: function(si, lat) {
			/** get latin reverse-translation if there is no latin text */
			if(lat == null) {
				lat = Sinhala.toLatin(si);
			}
			
			/** add word to wordlist, empty out input and dictionary lookup */
			tr.trans.innerHTML += '<div onclick="tr.editWord(' + tr.wordlist.length + ')" class="word">' + si + '</div>';
			tr.wordlist.push({ lat: lat, si: si });
			
			tr.dict.innerHTML	= '';
			tr.pinput.value		= '';
			tr.pinput.focus();
		},
		
		renderWordList: function() {
			/** when the whole wordlist needs to be re-rendered */
			var output = '';
			for(var i = 0; i < tr.wordlist.length; i++) {
				output += '<div onclick="tr.editWord(' + i + ')" class="word">' + tr.wordlist[i].si + '</div>';
			}
			tr.trans.innerHTML = output;
		},

		copyText: function() {
			//window.plugins.copy(tr.wordlist.join(' '));
			alert('Text Copied to Clipboard: ' + _.pluck(tr.wordlist, 'si').join(' ')); // change to toast
		},
		
		clearWords: function() {
			if(navigator.notification) {
				navigator.notification.confirm(
					'Are you sure you want to clear all text?', 
					tr.onClearConfirm, 'Clear All Text', 'Yes,Cancel');
			}
			else {
				var clear = window.confirm('Are you sure you want to clear all text?');
				if(clear) { tr.onClearConfirm(1); }
			}
		},
		
		onClearConfirm: function(index) {
			if(index == 1) {
				tr.wordlist			= [];
				tr.trans.innerHTML	= '';
			}
		}
	}
	
	document.addEventListener("deviceready", tr.create, false);
	</script>
</head>
<body onload="tr.create()">	
	<div class="content" id="content">
		<div id="translation"></div>
		
		<div id="dictionary"></div>
		
		<input id="pinput" type="text" placeholder="Type Something..." onkeyup="tr.engToSin(event)"  autocorrect="off" autocapitalize="off" autofocus>
	</div>

	<nav class="bar bar-tab">
		<a class="tab-item" onclick="tr.clearWords()">
			<span class="icon icon-close"></span>
			<span class="tab-label">Clear</span>
		</a>
		<a class="tab-item" href="#">
			<span class="icon icon-search"></span>
			<span class="tab-label">Search</span>
		</a>
		<a class="tab-item" onclick="tr.copyText()">
			<span class="icon icon-share"></span>
			<span class="tab-label">Share</span>
		</a>
	</nav>
</body>
</html>
